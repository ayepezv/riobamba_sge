# -*- coding: utf-8 -*-
##############################################################################
#
# Mario Chogllo
# mariofchogllo@gmail.com
#
##############################################################################

from time import strftime, strptime
import base64
import xlrd
from XLSWriter import XLSWriter

from osv import osv, fields

_STATE = [('draft','Borrador'),('pendiente','Aprobado/Pendiente Pago'),('pagado','Pagado')]

class hrVariosLine(osv.osv):
   _name = 'hr.varios.line'
   _description = 'Detalle Pagos Varios'
   _order = 'name'

   def _validar_mayor_cero(self, cr, uid, ids, context=None):
        obj = self.browse(cr, uid, ids[0], context=context)
        if obj.monto <= 0 or obj.descuento < 0 or obj.valor <0:
            return False
        return True
           
   _columns = dict(
      name = fields.many2one('res.partner','Beneficiario',required=True),
      varios_id = fields.many2one('hr.varios','Pagos varios',ondelete='cascade'),
      monto = fields.float('Valor',required=True),
      descuento = fields.float('Descuento'),
      valor = fields.float('Valor Total'),
      period_id = fields.related('varios_id','period_id',type="many2one",relation='account.period',string="Periodo",store=True),
       )

   _constraints = [
       (_validar_mayor_cero, 'Los valores deben ser mayor o igual a cero', ['monto']),
   ]
   
hrVariosLine()

class hrVarios(osv.osv):
    _name = 'hr.varios'
    _description = 'Pagos Varios'
    _order = 'name'

    _columns = dict(
       name = fields.char('Descripcion',size=64,required=True,states={'draft': [('readonly', False)]}),
       period_id = fields.many2one('account.period','Periodo',required=True,readonly=True,
                                   states={'draft': [('readonly', False)]}),
       observaciones = fields.char('Observaciones',size=128,readonly=True,states={'draft': [('readonly', False)]}),
       total = fields.float('Total'),
       line_ids = fields.one2many('hr.varios.line','varios_id','Detalle',readonly=True,states={'draft': [('readonly', False)]}),
       state = fields.selection(_STATE,'Estado'),
       archivo = fields.binary('Archivo'),
        )

    def load_varios_excel(self, cr, uid, ids, context=None):
       partner_obj = self.pool.get('res.partner')
       line_obj = self.pool.get('hr.varios.line')
       for this in self.browse(cr, uid, ids):
          anterior_ids = line_obj.search(cr, uid, [('varios_id','=',this.id)])
          line_obj.unlink(cr, uid, anterior_ids)
          if this.archivo:
             id_this = this.id
             arch = this.archivo
             arch_xls = base64.b64decode(arch)
             book = xlrd.open_workbook(file_contents=arch_xls)
             sh = book.sheet_by_name(book.sheet_names()[0])
             context={}
             for r in range(sh.nrows)[1:]:
                if sh.cell(r,0).value and sh.cell(r,1).value and sh.cell(r,2).value:
                  aux_ced = str(sh.cell(r,0).value)
                  partner_ids = partner_obj.search(cr, uid, [('ced_ruc','=',aux_ced)],limit=1)
                  if not partner_ids:
                      raise osv.except_osv(('Error Datos !'),
                                           ("No existe beneficiario '%s'") % (aux_ced)) 
                  line_obj.create(cr,uid, {
                     'name':partner_ids[0],
                     'varios_id':id_this,
                     'monto':sh.cell(r,2).value,
                     'descuento':sh.cell(r,3).value,
                  })
       return True

    def print_varios(self, cr, uid, ids, context=None):
        if not context:
            context = {}
        report = self.browse(cr, uid, ids, context)[0]
        datas = {'ids': [report.id], 'model': 'report.hr.varios'}
        return {
            'type': 'ir.actions.report.xml',
            'report_name': 'hr.varios',
            'model': 'hr.varios',
            'datas': datas,
            'nodestroy': True,                        
            }

    def unlink(self, cr, uid, ids, *args, **kwargs):
        for this in self.browse(cr, uid, ids):
            if this.state!='draft':
                raise osv.except_osv(('OperaciÃ³n no permitida !'), ('No puede eliminar, solo puede realizar esta operacion en estado Borrador'))
        return super(hrVarios, self).unlink(cr, uid, ids, *args, **kwargs)
    
    def a_borrador_varios(self, cr, uid, ids, context=None):
        for this in self.browse(cr, uid, ids):
            self.write(cr, uid, this.id,{'state':'draft'})
        return True
 
    def pendiente_varios(self, cr, uid, ids, context=None):
       line_obj = self.pool.get('hr.varios.line')
       for this in self.browse(cr, uid, ids):
          for line in this.line_ids:
             aux_tot = line.monto - line.descuento
             line_obj.write(cr, uid, line.id,{
                'valor':aux_tot,
             })
       self.write(cr, uid, this.id,{'state':'pendiente'})
       return True

    _defaults = dict(
        state = 'draft',
        )

hrVarios()


