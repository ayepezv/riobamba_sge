# -*- coding: utf-8 -*-
##############################################################################
#
# Mario Chogllo
# mariofchogllo@gmail.com
#
##############################################################################
import time
from report import report_sxw
from osv import fields, osv
from gt_tool import XLSWriter
import re

total_todo = []
cabecera_todo = []

class activo_valorado(report_sxw.rml_parse):
    def __init__(self, cr, uid, name, context):
        super(activo_valorado, self).__init__(cr, uid, name, context=context)
        self.localcontext.update({
            'time': time,
            'cr':cr,
            'uid': uid,
#            'generate_dict': self.generate_dict,
#            'all_programas': self.all_programas,
#            'roles_programa': self.roles_programa,
#            'get_rubro_total': self.get_rubro_total,
#            'put_cabecera': self.put_cabecera,
        })

    def roles_programa(self, payroll,programa):
        roles_obj = self.pool.get('hr.payslip')
        roles_ids = roles_obj.search(self.cr, self.uid, [('payslip_run_id','=',payroll.id),('program_id','=',programa.id)])
        #mandar browse de los roles
        return roles_obj.browse(self.cr, self.uid, roles_ids)

    def all_programas(self, obj):
        programas = []
        programas_aux = []
        programas_ids = []
        programa_obj = self.pool.get('project.program')
        for rol_individual in obj.slip_ids:
            if not rol_individual.program_id.sequence in programas_aux:
                programas_aux.append(rol_individual.program_id.sequence)
                programas.append({'sequence':rol_individual.program_id.sequence})
        data = sorted(programas, key=lambda k: k['sequence'])    
        for programa_sort in data:
            programa_ids = programa_obj.search(self.cr, self.uid, [('sequence','=',programa_sort['sequence'])],limit=1)
            if not programa_ids:
                print "NO POGAMA", programa_sort['sequence']
            programas_ids.append(programa_ids[0])
        return programa_obj.browse(self.cr, self.uid, programas_ids)#programas

       
report_sxw.report_sxw('report.activo_valorado',
                       'departamento.valor', 
                       'addons/gt_account_asset/report/activo_valorado.mako',
                       parser=activo_valorado,
                       header=False)

