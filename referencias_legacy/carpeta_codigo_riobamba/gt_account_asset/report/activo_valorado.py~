# -*- coding: utf-8 -*-
##############################################################################
#
# Mario Chogllo
# mariofchogllo@gmail.com
#
##############################################################################
import time
from report import report_sxw
from osv import fields, osv
from gt_tool import XLSWriter
import re

total_todo = []
cabecera_todo = []

class activo_valorado(report_sxw.rml_parse):
    def __init__(self, cr, uid, name, context):
        super(activo_valorado, self).__init__(cr, uid, name, context=context)
        self.localcontext.update({
            'time': time,
            'cr':cr,
            'uid': uid,
            'generate_dict_valorado': self.generate_dict_valorado,
        })

    def generate_dict_valorado(self, this):
        dept_obj = self.pool.get('hr.department')
        categ_obj = self.pool.get('account.asset.category')
        asset_obj = self.pool.get('account.asset.asset')
        if this.tipo=='Todos':
            dept_ids = dept_obj.search(self.cr, self.uid, [])
            categ_ids = categ_obj.search(self.cr, self.uid, [])
        else:
            for dept_id in this.dept_ids:
                dept_ids.append(dept_id)
            for categ_id in this.categ_ids:
                categ_ids.append(categ_id)
        if categ_ids:
            result = []
            cabecera = ['DEPARTAMENTO']
            for categ_id in categ_ids:
                categoria = categ_obj.browse(self.cr, self.uid, categ_id)
                cabecera.append(categoria.name)
            result.append(cabecera)
            result.append([''])
            for dept_id in dept_ids:
                linea = []
                departamento = dept_obj.browse(self.cr, self.uid, dept_id)
                linea = [departamento.name]
                for categ_id in categ_ids:
                    aux_valor = 0
                    asset_ids = asset_obj.search(self.cr, self.uid, [('department_id','=',dept_id),('category_id','=',categ_id)])
                    if asset_ids:
                        for asset_id in asset_ids:
                            asset = asset_obj.browse(self.cr, self.uid, asset_id)
                            aux_valor += asset.purchase_value
                    linea.append(aux_valor)
                result.append(linea)
                result.append([''])
            total = ['TOTAL']
        print "resulttttt", result
        return result

       
report_sxw.report_sxw('report.activo_valorado',
                       'departamento.valor', 
                       'addons/gt_account_asset/report/activo_valorado.mako',
                       parser=activo_valorado,
                       header=False)

