# -*- coding: utf-8 -*-
##############################################################################
#
#    HHRR Module
#    Copyright (C) 2009 GnuThink Software  All Rights Reserved
#    info@gnuthink.com
#    $Id$
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
##############################################################################

import time

from osv import osv
from osv import fields
import base64
import pooler
from XLSWriter import XLSWriter
import StringIO
import xlrd
import netsvc

class import_stock(osv.osv_memory):

    _name='import.stock'
    
    _columns={
        'name':fields.char('Observaciones',size=128),
        'archivo':fields.binary('Archivo', required=True),
        }

    def _bad_archivo(self, cr, uid, ids, arch,context=None):
        result=True
        acc_obj=self.pool.get('account.account')
        arch_xls = base64.b64decode(arch)
        book = xlrd.open_workbook(file_contents=arch_xls)
        sh = book.sheet_by_name(book.sheet_names()[0])
        j=i=0
        for r in range(sh.nrows)[1:]:
            i+=1
            if sh.cell(r,0).value and sh.cell(r,1).value:
 #               import pdb
 #               pdb.set_trace()
                cta_id = acc_obj.search(cr, uid, [('code','=',sh.cell(r,0).value)])
                cta_comp_id=acc_obj.search(cr, uid, [('code','=',sh.cell(r,1).value)])
                if not len(cta_id)>0: 
                    raise osv.except_osv(('Error de archivo!'),'La cta %s , en la linea numero %d no corresponde a nigun empleado'%((str(sh.cell(r,1).value)),i+1))
                if not len(cta_comp_id)>0: 
                    raise osv.except_osv(('Error de archivo!'),'La cta %s comp, en la linea numero %d no corresponde a nigun empleado'%((str(sh.cell(r,1).value)),i+1))
            else:
                raise osv.except_osv(('Error de archivo!'),'Existe un campo que esta vacio en la linea %s '%(r))
#        if j==sh.nrows:
#            result=False
        return result

    def import_stock(self, cr, uid, ids, context=None):
        inv_obj=self.pool.get('stock.inventory')
        inv_line_obj=self.pool.get('stock.inventory.line')
        p_obj = self.pool.get('product.product')
        data = self.read(cr, uid, ids)[0]
#        self._bad_archivo(cr, uid, ids, data['archivo'],context=context)
        if context is None:
            context = {}
        if data['archivo']:
            arch = data['archivo']
            arch_xls = base64.b64decode(arch)
            book = xlrd.open_workbook(file_contents=arch_xls)
            sh = book.sheet_by_name(book.sheet_names()[0])
            context={}
            inv_id = inv_obj.create(cr, uid, {'name':data['name']})
            for r in range(sh.nrows)[1:]:
                product_id = p_obj.search(cr, uid, [('default_code','=',sh.cell(r,0).value)])
                qty = sh.cell(r,1).value
                if product_id:
                    product = p_obj.browse(cr, uid, product_id[0])
                    inv_line_obj.create(cr,uid,{
                            'inventory_id':inv_id,
                            'location_id':product.location_id.id,
                            'product_id':product_id[0],
                            'product_uom':product.uom_id.id,
                            'product_qty':sh.cell(r,1).value,
                            })
                else:
                    print "No hay el product", sh.cell(r,0).value
        return {'type':'ir.actions.act_window_close' }

import_stock()


