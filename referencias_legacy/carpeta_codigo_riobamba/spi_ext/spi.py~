# -*- coding: utf-8 -*-
##############################################################################
#
# MarioChogllo
# mariofchogllo@gmail.com
#
##############################################################################

class spiLine(osv.Model):
    _inherit = 'spi.line'
    _columns = dict(
        ref = fields.related('concepto_id','code',type='char',size=6,store=True,'Referencia BCE'),
        concepto_id = fields.many2one('spi.concepto','Concepto Egresos'),
    )
spiLine()

class spi_voucher(osv.Model):
    _inherit = 'account.spi.voucher'

    def spi_import_normal(self,cr, uid, ids, context):
        concepto_obj = self.pool.get('spi.concepto')
        line_obj = self.pool.get('spi.line')
        partner_obj = self.pool.get('res.partner')
        journal_obj = self.pool.get('account.journal')
        anteriores = []
        for this in self.browse(cr, uid, ids):
            for line in this.line_ids:
                anteriores.append(line.id)
            line_obj.unlink(cr, uid, anteriores)
            if this.tipo=='pgeneral':
                if this.line2_ids:
                    for line in this.line2_ids:
                        if line.partner_id.bank_ids: 
                            ##carga el tipo de pago: 40102 bienes y srv,40101 sueldos,40300 inversion
                            for line_asiento in line.line_id:
                                if int(str(line_asiento.account_id.code[0:1]))>=1 and  int(str(line_asiento.account_id.code[0:1]))<=3:
                                    if line_asiento.debit>0:
                                        aux_ref = 0
                                        aux_code_acc = line_asiento.account_id.code
                                        aux_code_min = aux_code_acc[0:4]
                                        if aux_code_min == '2137': #inversion
                                            concepto_ids = concepto_obj.search(cr, uid, [('code','=',line_asiento.account_id.budget_post.code[0:4])])
                                            if concepto_ids:
                                                concepto_id = concepto_ids[0]
#                                            aux_ref = 40300
                                            break
                                        elif aux_code_min in ('1121','1120'): #anticipos
                                            concepto_ids = concepto_obj.search(cr, uid, [('code','=','40102')])
                                            if concepto_ids:
                                                concepto_id = concepto_ids[0]
#                                            aux_ref = 40101
                                            break
                                        elif aux_code_min in ('2135'):
                                            concepto_ids = concepto_obj.search(cr, uid, [('aux_partida','=',line_asiento.account_id.budget_post.code[0:4])])
                                            if concepto_ids:
                                                concepto_id = concepto_ids[0]
#                                            aux_ref = 40102
                                            break
                                        else:
                                            concepto_ids = concepto_obj.search(cr, uid, [('aux_partida','=',line_asiento.account_id.budget_post.code[0:4])])
                                            if concepto_ids:
                                                concepto_id = concepto_ids[0]
#                                            aux_ref = 40102
                                            break
                                else:
                                    aux_ref = 40101
                            bank_id = line.partner_id.bank_ids[0].id
                            aux_name = 'PAGO ' + line.name
                            #validar que solo tome el valor de la cuenta de banco
                            amount_pagar = 0
                            for line_asiento in line.line_id:
                                if line_asiento.credit>0:
                                    aux_account_id = line_asiento.account_id
                                    journal_ids = journal_obj.search(cr, uid, [('type','=','bank'),('default_credit_account_id','=',line_asiento.account_id.id)])
                                    if journal_ids:
                                        amount_pagar = line_asiento.credit
                                        break
                            if amount_pagar <=0:
                                aux_cta_pagar = aux_account_id.code + ' - ' + aux_account_id.name
                                raise osv.except_osv(('Error Configuracion !'),
                                                     ("No existe cuenta de banco en el movimiento contable a pagar '%s' o el monto es menor a 1") % (aux_cta_pagar))
                            line_obj.create(cr, uid, {
                                'spi_id':this.id,
                                'partner_id':line.partner_id.id,
                                'amount':amount_pagar,#line.amount,
                                'name':aux_name,
                                'bank_id':bank_id,
                                #'ref':aux_ref,  #cambiar por la tabla se hace related
                                'concepto_id':concepto_id,
                            })
                        else:
                            raise osv.except_osv(('Error Configuracion !'),("No existe cuenta de banco de '%s'") % (line.partner_id.name,))
            elif this.tipo=='quincena':
                if this.quincena_id:
                    for line_quincena in this.quincena_id.line_ids:
                        for line_line_quincena in line_quincena.line_ids:
                            for line_line_line in line_line_quincena.line_ids:
                                employee = line_line_line.employee_id
                                partner_ids = partner_obj.search(cr, uid, [('ced_ruc','=',employee.name)],limit=1)
                                if not partner_ids:
                                    raise osv.except_osv(('Error'), 
                                                         ('El beneficiario %s no esta en la base de proveedores debe estar registrado') % (employee.complete_name))
                                partner = partner_obj.browse(cr, uid, partner_ids[0])
                                if partner.bank_ids:
                                    bank_id = partner.bank_ids[0].id
                                    aux_name = ustr('PAGO QUINCENA' + employee.complete_name)
                                    aux_ref = '40101'
                                    line_obj.create(cr, uid, {
                                        'spi_id':this.id,
                                        'partner_id':partner.id,
                                        'amount':line_line_line.valor,
                                        'name':aux_name,
                                        'ref':aux_ref,
                                        'bank_id':bank_id,
                                    })
                                else:
                                    raise osv.except_osv(('Error'), ('El beneficiario %s no tiene cuenta de banco,registre una') % (employee.complete_name))
            elif this.tipo=='mensual':
                if this.payroll_id:
                    for slip in this.payroll_id.slip_ids:
                        employee = slip.employee_id
                        partner_ids = partner_obj.search(cr, uid, [('ced_ruc','=',employee.name)],limit=1)
                        if not partner_ids:
                            raise osv.except_osv(('Error'), ('El beneficiario %s no esta en la base de proveedores debe estar registrado') % (employee.complete_name))
                        partner = partner_obj.browse(cr, uid, partner_ids[0])
                        if partner.bank_ids:
                            bank_id = partner.bank_ids[0].id
                            aux_name = ustr('PAGO MENSUAL ' + employee.complete_name)
                            aux_ref = '40101'
                            if slip.net<0:
                                raise osv.except_osv(('Error'), ('No se puede pagar un rol negativo, verificar rol de %s ') % (partner.name))
                            line_obj.create(cr, uid, {
                                'spi_id':this.id,
                                'partner_id':partner.id,
                                'amount':slip.net,
                                'name':aux_name,
                                'ref':aux_ref,
                                'bank_id':bank_id,
                            })
                        else:
                            raise osv.except_osv(('Error'), ('El beneficiario %s no tiene cuenta de banco,registre una') % (employee.complete_name))
            elif this.tipo=='dec3':
                if this.dec3_id:
                    for decimo in this.dec3_id.line_ids:
                        employee = decimo.contract_id.employee_id
                        partner_ids = partner_obj.search(cr, uid, [('ced_ruc','=',employee.name)],limit=1)
                        if not partner_ids:
                            raise osv.except_osv(('Error'), ('El beneficiario %s no esta en la base de proveedores debe estar registrado') % (employee.complete_name))
                        partner = partner_obj.browse(cr, uid, partner_ids[0])
                        if partner.bank_ids:
                            bank_id = partner.bank_ids[0].id
                            aux_name = ustr('PAGO DECIMO TERCERO ' + employee.complete_name)
                            aux_ref = '40101'
                            if decimo.recibir<0:
                                raise osv.except_osv(('Error'), ('No se puede pagar decimo negativo, verificar rol de %s ') % (partner.name))
                            line_obj.create(cr, uid, {
                                'spi_id':this.id,
                                'partner_id':partner.id,
                                'amount':decimo.recibir,
                                'name':aux_name,
                                'ref':aux_ref,
                                'bank_id':bank_id,
                            })
                        else:
                            raise osv.except_osv(('Error'), ('El beneficiario %s no tiene cuenta de banco,registre una') % (employee.complete_name))
            elif this.tipo=='dec4':
                if this.dec4_id:
                    for decimo in this.dec4_id.line_ids:
                        employee = decimo.contract_id.employee_id
                        partner_ids = partner_obj.search(cr, uid, [('ced_ruc','=',employee.name)],limit=1)
                        if not partner_ids:
                            raise osv.except_osv(('Error'), ('El beneficiario %s no esta en la base de proveedores debe estar registrado') % (employee.complete_name))
                        partner = partner_obj.browse(cr, uid, partner_ids[0])
                        if partner.bank_ids:
                            bank_id = partner.bank_ids[0].id
                            aux_name = ustr('PAGO DECIMO CUARTO ' + employee.complete_name)
                            aux_ref = '40101'
                            if decimo.recibir<0:
                                raise osv.except_osv(('Error'), ('No se puede pagar decimo negativo, verificar rol de %s ') % (partner.name))
                            line_obj.create(cr, uid, {
                                'spi_id':this.id,
                                'partner_id':partner.id,
                                'amount':decimo.recibir,
                                'name':aux_name,
                                'ref':aux_ref,
                                'bank_id':bank_id,
                            })
                        else:
                            raise osv.except_osv(('Error'), ('El beneficiario %s no tiene cuenta de banco,registre una') % (employee.complete_name))
            elif this.tipo=='varios':
                if this.varios_id:
                    for line in this.varios_id.line_ids:
                        partner = line.name
                        if not partner.bank_ids:
                            raise osv.except_osv(('Error'), ('El beneficiario %s no tiene cuenta de banco,registre una') % (partner.name))
                        bank_id = partner.bank_ids[0].id
                        aux_name = ustr('PAGO: ' + this.varios_id.name)
                        aux_ref = '40101'
                        line_obj.create(cr, uid, {
                            'spi_id':this.id,
                            'partner_id':partner.id,
                            'amount':line.valor,
                            'name':aux_name,
                            'ref':aux_ref,
                            'bank_id':bank_id,
                        })
        return True
        
        _columns = dict(
            
        )

spi_voucher()
