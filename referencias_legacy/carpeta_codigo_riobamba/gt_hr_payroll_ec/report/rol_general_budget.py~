# -*- coding: utf-8 -*-
##############################################################################
#
# Mario Chogllo
# mariofchogllo@gmail.com
#
##############################################################################
import time
from report import report_sxw
from osv import fields, osv
from gt_tool import XLSWriter
import re

total_todo = []
cabecera_todo = []

class rol_general_budget(report_sxw.rml_parse):
    def __init__(self, cr, uid, name, context):
        super(rol_general_budget, self).__init__(cr, uid, name, context=context)
        self.localcontext.update({
            'time': time,
            'cr':cr,
            'uid': uid,
            'generate_dict': self.generate_dict,
            'all_programas': self.all_programas,
            'roles_programa': self.roles_programa,
            'get_rubro_total': self.get_rubro_total,
            'put_cabecera': self.put_cabecera,
        })

    def roles_programa(self, payroll,programa):
        roles_obj = self.pool.get('hr.payslip')
        roles_ids = roles_obj.search(self.cr, self.uid, [('payslip_run_id','=',payroll.id),('program_id','=',programa.id)])
        #mandar browse de los roles
        return roles_obj.browse(self.cr, self.uid, roles_ids)

    def all_programas(self, obj):
        programas = []
        programas_aux = []
        programas_ids = []
        programa_obj = self.pool.get('project.program')
        for rol_individual in obj.slip_ids:
            if not rol_individual.program_id.sequence in programas_aux:
                programas_aux.append(rol_individual.program_id.sequence)
                programas.append({'sequence':rol_individual.program_id.sequence})
        data = sorted(programas, key=lambda k: k['sequence'])    
        for programa_sort in data:
            programa_ids = programa_obj.search(self.cr, self.uid, [('sequence','=',programa_sort['sequence'])],limit=1)
            if not programa_ids:
                print "NO POGAMA", programa_sort['sequence']
            programas_ids.append(programa_ids[0])
        return programa_obj.browse(self.cr, self.uid, programas_ids)#programas

    def get_rubros(self, roles_ids):
        rol_obj = self.pool.get('hr.payslip')
        rule_obj = self.pool.get('hr.salary.rule')
        rubros_ingreso = []
        rubros_egreso = []
        for rol_individual_id in roles_ids:#registro.payroll_id.slip_ids:
            rol_individual = rol_obj.browse(self.cr, self.uid, rol_individual_id)
            for rubro in rol_individual.line_ids:
                #rubro tiene la informacion (id,secuencia,name) exepto otros ingresos y otros egresos, estos se agregan al final OtrosDescuentos y OING
                if rubro.salary_rule_id.category_id.code in ('BASIC','ING','APT'):
                    if not rubro.salary_rule_id.agrupar:
                        if not [rubro.salary_rule_id.id,rubro.salary_rule_id.sequence,rubro.salary_rule_id.name] in rubros_ingreso:
                            rubros_ingreso.append([rubro.salary_rule_id.id,rubro.salary_rule_id.sequence,rubro.salary_rule_id.name])
                elif rubro.salary_rule_id.category_id.code == 'EGR':
                    if not rubro.salary_rule_id.agrupar:
                        if not [rubro.salary_rule_id.id,rubro.salary_rule_id.sequence,rubro.salary_rule_id.name] in rubros_egreso:
                            rubros_egreso.append([rubro.salary_rule_id.id,rubro.salary_rule_id.sequence,rubro.salary_rule_id.name])
        #si no hay de adem agregar al diccionario
        adem_aux = 0
        for line_aux in rubros_egreso:
            if line_aux[2]=='ADEM':
                adem_aux += 1
                break
        if adem_aux<1:
            rule_ids_adem = rule_obj.search(self.cr, self.uid, [('code','=','ADEM')],limit=1)
            if rule_ids_adem:
                rubro_adem = rule_obj.browse(self.cr, self.uid, rule_ids_adem[0])
                rubros_egreso.append([rubro_adem.id,rubro_adem.sequence,rubro_adem.name])
        rule_ids_ing = rule_obj.search(self.cr, self.uid, [('code','=','OING')],limit=1)
#        if rule_ids_ing:
#            rubro = rule_obj.browse(self.cr, self.uid, rule_ids_ing[0])
#            rubros_ingreso.append([rubro.id,rubro.sequence,rubro.name])
#        rule_ids_egr = rule_obj.search(self.cr, self.uid, [('code','=','OtrosDescuentos')],limit=1)
#        if rule_ids_egr:
#            rubro = rule_obj.browse(self.cr, self.uid, rule_ids_egr[0])
#            rubros_egreso.append([rubro.id,rubro.sequence,rubro.name])
        #totales ingresos y egresos            
        rule_ids_total_ing = rule_obj.search(self.cr, self.uid, [('code','=','NET'),('name','=','TOTAL INGRESOS')],limit=1)
        if rule_ids_total_ing:
            rubro = rule_obj.browse(self.cr, self.uid, rule_ids_total_ing[0])
            rubros_ingreso.append([rubro.id,rubro.sequence,rubro.name])
        rule_ids_total_egr = rule_obj.search(self.cr, self.uid, [('code','=','NET'),('name','=','TOTAL EGRESOS')],limit=1)
        if rule_ids_total_egr:
            rubro = rule_obj.browse(self.cr, self.uid, rule_ids_total_egr[0])
            rubros_egreso.append([rubro.id,rubro.sequence,rubro.name])
        rule_ids_total = rule_obj.search(self.cr, self.uid, [('code','=','NET'),('name','=','TOTAL')],limit=1)
        if rule_ids_total:
            rubro = rule_obj.browse(self.cr, self.uid, rule_ids_total[0])
            rubros_egreso.append([rubro.id,rubro.sequence,rubro.name])
        return rubros_ingreso + rubros_egreso

    def put_cabecera(self, payroll):
        linea_cab = []
        head = cabecera_todo[0]
        k = 0 
        for k in range(len(cabecera_todo)-1):
            if k>0:
                linea_cab.append(head[k])
        return linea_cab

    def get_rubro_total(self, payroll):
        rol_obj = self.pool.get('hr.payslip')
        roles_all = rol_obj.search(self.cr, self.uid, [('payslip_run_id','=',payroll.id)])
        aux_total_emp = len(roles_all)
        rubros = self.get_rubros(roles_all)
        linea_todo = []
        dict_final = []
        linea_r = []
        #RUBROS
        linea_r.append("TOTAL FUNCIONARIOS")
        linea_r.append("RUBROS")
        linea_r.append("==========")
        for ma in range(len(rubros)):
            linea_r.append(rubros[ma][2])
        #TOTALES
        linea_todo.append(str(aux_total_emp))
        linea_todo.append("TOTAL")
        linea_todo.append("==========")
        for ms in range(len(total_todo[0])):
            aux_suma = 0
            if ms>1:
                for todo_line in total_todo:
                    aux_suma += todo_line[ms]
                linea_todo.append(aux_suma)
        dict_final.append(linea_r)
        dict_final.append(linea_todo)  
        global total_todo
        total_todo = []
        return dict_final

    def generateTotal(self, payroll, programa):
        return True

    def generate_dict(self, payroll,programa):
        rol_obj = self.pool.get('hr.payslip')
        rule_obj = self.pool.get('hr.salary.rule')
        diccionario = {}
        diccionario_totales = {}
        programas = []
        departamentos = []
        rubros = []
#        cabecera_todo = []
        lineas_depto = []
        global total_todo
        #total_todo = []
        band = True
        if band:
            programas.append([programa.id,programa.sequence,programa.name])
            #antes desde halla armar en otro metodo los programas y se manda solo los slip de esos programas
            roles_ids = rol_obj.search(self.cr, self.uid, [('payslip_run_id','=',payroll.id),('program_id','=',programa.id)],order='budget_id_ind desc')
            roles_all = rol_obj.search(self.cr, self.uid, [('payslip_run_id','=',payroll.id)])
            rubros = self.get_rubros(roles_all)
            for rol_individual_id in roles_ids:#registro.payroll_id.slip_ids:
                rol_individual = rol_obj.browse(self.cr, self.uid, rol_individual_id)
                for rubro in rol_individual.line_ids:#payslip lines
                    #rubro tiene la informacion (id,secuencia,name)
                    #rubros.append([rubro.salary_rule_id.id,rubro.salary_rule_id.sequence,rubro.salary_rule_id.name])
                    #departamentos tiene el par (id,name)
                    #ojo aqui toma del rol pero al rol no  va en algunos casos voy a tomar del contrato o del empleado
#                    departamentos.append([rol_individual.department_id.id,rol_individual.department_id.name])
                    departamentos.append([rol_individual.employee_id.department_id.id,rol_individual.employee_id.department_id.name])
                    #programa tiene el par (id,name)
                    if diccionario.has_key(rol_individual.contract_id.program_id.id):
                      if diccionario[rol_individual.contract_id.program_id.id].has_key(rol_individual.employee_id.department_id.id):
                        if diccionario[rol_individual.contract_id.program_id.id][rol_individual.employee_id.department_id.id].has_key(rol_individual.employee_id.complete_name):
                            #aqui se viene contra la linea del rol y el rubro
                            #preguntar si no es agrpado pase
                            if not rubro.salary_rule_id.agrupar:
                                if diccionario[rol_individual.contract_id.program_id.id][rol_individual.employee_id.department_id.id][rol_individual.employee_id.complete_name].has_key(rubro.salary_rule_id.id):
                                    diccionario[rol_individual.contract_id.program_id.id][rol_individual.employee_id.department_id.id][rol_individual.employee_id.complete_name][rubro.salary_rule_id.id] += rubro.amount
                                else:
                                    diccionario[rol_individual.contract_id.program_id.id][rol_individual.employee_id.department_id.id][rol_individual.employee_id.complete_name][rubro.salary_rule_id.id] = rubro.amount
                            else:
                                #buscar los de agrupacion de ingresos y egresos
                                if rubro.salary_rule_id.category_id.code in ('ING','APT'):
                                    rule_ids_ing = rule_obj.search(self.cr, self.uid, [('code','=','OING')],limit=1)
                                    if rule_ids_ing:
                                        rubro_aux = rule_obj.browse(self.cr, self.uid, rule_ids_ing[0])
                                elif rubro.salary_rule_id.category_id.code in ('EGR'):
                                    #todo al ADEM
                                    rule_ids_egr = rule_obj.search(self.cr, self.uid, [('code','=','ADEM')],limit=1)
                                    if rule_ids_egr:
                                        rubro_aux = rule_obj.browse(self.cr, self.uid, rule_ids_egr[0])
                                if diccionario[rol_individual.contract_id.program_id.id][rol_individual.employee_id.department_id.id][rol_individual.employee_id.complete_name].has_key(rubro_aux.id):
                                    diccionario[rol_individual.contract_id.program_id.id][rol_individual.employee_id.department_id.id][rol_individual.employee_id.complete_name][rubro_aux.id] += rubro.amount
                                else:
                                    diccionario[rol_individual.contract_id.program_id.id][rol_individual.employee_id.department_id.id][rol_individual.employee_id.complete_name][rubro_aux.id] = rubro.amount
                        else:
                            diccionario[rol_individual.contract_id.program_id.id][rol_individual.employee_id.department_id.id][rol_individual.employee_id.complete_name] = {'cedula': rol_individual.employee_id.name, 'tipo cuenta': (rol_individual.employee_id.bank_account_id and rol_individual.employee_id.bank_account_id.type_cta or '-'), 'numero cuenta': (rol_individual.employee_id.bank_account_id and rol_individual.employee_id.bank_account_id.acc_number or '-'), 'partida': (rol_individual.contract_id.budget_ind and rol_individual.contract_id.budget_ind or '-'), rubro.salary_rule_id.id: rubro.amount}
                      else:
                        diccionario[rol_individual.contract_id.program_id.id][rol_individual.employee_id.department_id.id] = {rol_individual.employee_id.complete_name: {'cedula': rol_individual.employee_id.name, 'tipo cuenta': (rol_individual.employee_id.bank_account_id and rol_individual.employee_id.bank_account_id.type_cta or '-'), 'numero cuenta': (rol_individual.employee_id.bank_account_id and rol_individual.employee_id.bank_account_id.acc_number or '-'), 'partida': (rol_individual.contract_id.budget_ind and rol_individual.contract_id.budget_ind or '-'), rubro.salary_rule_id.id: rubro.amount}}
                    else:
                        diccionario[rol_individual.contract_id.program_id.id] ={rol_individual.employee_id.department_id.id: {rol_individual.employee_id.complete_name: {'cedula': rol_individual.employee_id.name, 'tipo cuenta': (rol_individual.employee_id.bank_account_id and rol_individual.employee_id.bank_account_id.type_cta or '-'), 'numero cuenta': (rol_individual.employee_id.bank_account_id and rol_individual.employee_id.bank_account_id.acc_number or '-'), 'partida': (rol_individual.contract_id.budget_ind and rol_individual.contract_id.budget_ind or '-'), rubro.salary_rule_id.id: rubro.amount}}}
                    #al final del for del rol colocar los totales de ingresos y egresos
                    rule_ids_tot_ing = rule_obj.search(self.cr, self.uid, [('name','=','TOTAL INGRESOS')],limit=1)
                    if rule_ids_tot_ing:
                        rubro_aux_tot_ing = rule_obj.browse(self.cr, self.uid, rule_ids_tot_ing[0])
                        diccionario[rol_individual.contract_id.program_id.id][rol_individual.employee_id.department_id.id][rol_individual.employee_id.complete_name][rubro_aux_tot_ing.id] = rol_individual.aportable + rol_individual.allowance + rol_individual.basic
                    rule_ids_tot_egr = rule_obj.search(self.cr, self.uid, [('name','=','TOTAL EGRESOS')],limit=1)
                    if rule_ids_tot_egr:
                        rubro_aux_tot_egr = rule_obj.browse(self.cr, self.uid, rule_ids_tot_egr[0])
                        diccionario[rol_individual.contract_id.program_id.id][rol_individual.employee_id.department_id.id][rol_individual.employee_id.complete_name][rubro_aux_tot_egr.id] = rol_individual.deduction
                    rule_ids_total = rule_obj.search(self.cr, self.uid, [('name','in',('TOTAL','NETO A RECIBIR'))],limit=1)
                    if rule_ids_total:
                        aux = rol_individual.aportable + rol_individual.allowance + rol_individual.basic - rol_individual.deduction
                        if aux<0.1:
                            aux = round(aux,2)
                        rubro_aux_total = rule_obj.browse(self.cr, self.uid, rule_ids_total[0])
                        diccionario[rol_individual.contract_id.program_id.id][rol_individual.employee_id.department_id.id][rol_individual.employee_id.complete_name][rubro_aux_total.id] = aux#rol_individual.aportable + rol_individual.allowance + rol_individual.basic - rol_individual.deduction
        programa_clean = []
        for key in programas:
            if key not in programa_clean:
                programa_clean.append(key)                
        departamentos_clean = []
        for key in departamentos:
            if key not in departamentos_clean:
                departamentos_clean.append(key)
        rubros_clean = rubros
        programa_clean.sort(key=lambda x: x[0])
        departamentos_clean.sort(key=lambda x: x[0])
        writer = XLSWriter.XLSWriter()
        writer_dict = []
        cabecera = ['NUM.','FUNCIONARIO: APELLIDOS Y NOMBRES']
        pie = {}
        for rubro in rubros_clean:
            cabecera.append(rubro[2])
        cabecera.append("PARTIDA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")
        writer.append(cabecera)
        writer_dict.append(cabecera)
        cabecera_todo.append(cabecera)
        for programa in programa_clean:
          for departamento in departamentos_clean:
            pie = {}
            j =0 
            if not diccionario.has_key(programa[0]):
                continue
            if not diccionario[programa[0]].has_key(departamento[0]):
                continue
            linea = ['','DEPARTAMENTO',departamento[1]]
            #writer.append([''])
            #writer.append(linea)
            #writer_dict.append([''])
            #writer_dict.append(linea)
            j = 0
            claves  = diccionario[programa[0]][departamento[0]].keys()
            claves.sort()
            for empleado in claves:
                j += 1
                linea = [j]
                ocurrencias = False
                ocur_aux = re.finditer(" ",empleado)
                ocur_index = 0
                for m in ocur_aux:
                    ocur_index += 1
                    ocurrencias = m.start()
                if ocur_index == 3:
                    linea.append(empleado[0:ocurrencias])
                else:
                    linea.append(empleado)
                for rubro in rubros_clean:
#                    j += 1
                    if not pie.has_key(rubro[0]):
                        pie.update({rubro[0]:0.00})
                    if diccionario[programa[0]][departamento[0]][empleado].has_key(rubro[0]):
                        linea.append(diccionario[programa[0]][departamento[0]][empleado][rubro[0]])
                        pie[rubro[0]] = pie[rubro[0]] + diccionario[programa[0]][departamento[0]][empleado][rubro[0]]
                    else:
                        linea.append(0.00)
                linea.append(diccionario[programa[0]][departamento[0]][empleado]['partida'])
                writer.append(linea)
                writer_dict.append(linea)
            linea = ['','TOTAL DEPARTAMENTO']
            for rubro in rubros_clean:
                linea.append(pie[rubro[0]])
            lineas_depto.append(linea)
            #writer.append(linea)
            #writer_dict.append(linea)
          #total por programa
        linea2 = ['','TOTAL PROGRAMA']
#        total_todo = []
        for m in range(len(lineas_depto[0])):
            if m>1:
                aux_sum = 0
                for line_dp in lineas_depto:
                    aux_sum += line_dp[m]
                linea2.append(aux_sum)
        writer.append(linea2)
        writer_dict.append(linea2)
        total_todo.append(linea2)
        writer.save("resumen_rol.xls")
        out = open("resumen_rol.xls","rb").read().encode("base64")
#        self.write(cr, uid, ids, {'datas': out, 'datas_fname': 'resumen_rol.xls'})
        return writer_dict
        
            
      
report_sxw.report_sxw('report.rol_general_budget',
                       'hr.payslip.run', 
                       'addons/gt_hr_payroll_ec/report/rol_general_budget.mako',
                       parser=rol_general_budget,
                       header=False)
