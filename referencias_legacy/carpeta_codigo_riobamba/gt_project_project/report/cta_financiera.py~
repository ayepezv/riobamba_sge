# -*- coding: utf-8 -*-
##############################################################################
#
# Mario Chogllo
# mariofchogllo@gmail.com
#
##############################################################################
import time
from report import report_sxw
from osv import fields, osv
from gt_tool import XLSWriter
import re

class resumen_gasto(report_sxw.rml_parse):
    def __init__(self, cr, uid, name, context):
        super(resumen_gasto, self).__init__(cr, uid, name, context=context)
        self.localcontext.update({
            'time': time,
            'cr':cr,
            'uid': uid,
            'get_budget_gp': self.get_budget_gp,
            'get_programa_name':self.get_programa_name,
            'get_programa_gp': self.get_programa_gp,
        })


    def get_programa_name(self, p_id):
        program_obj = self.pool.get('project.program')
        aux = ''
        programa = program_obj.browse(self.cr, self.uid, p_id)
        aux = programa.sequence + ' - ' + programa.name
        return aux


    def get_programa_gp(self, poa):
        programa_list = []
        project_obj = self.pool.get('project.project')
        project_ids = project_obj.search(self.cr, self.uid, [('poa_id','=',poa.id),('type_budget','=','gasto')])
        for project_id in project_ids:
            project = project_obj.browse(self.cr, self.uid, project_id)
            if not project.program_id.id in programa_list:
                programa_list.append(project.program_id.id)
        return programa_list

    def get_budget_gp(self, program_id,text,text1):
        budget_item_obj = self.pool.get('budget.item')
        budget_ids_1 = budget_item_obj.search(self.cr, self.uid, [('program_id','=',program_id),('code_aux','=like',text+"%")])
        budget_ids_2 = []
        if text1!='0':
            budget_ids_2 = budget_item_obj.search(self.cr, self.uid, [('program_id','=',program_id),('code_aux','=like',text1+"%")])
        context = {}
        total = 0 
        budget_ids = budget_ids_1 + budget_ids_2
        for budget_id in budget_ids:
            budget = budget_item_obj.browse(self.cr, self.uid, budget_id,context)
            total += budget.planned_amount
        return total

report_sxw.report_sxw('report.resumen_gasto',
                       'resumen.gasto.wizard', 
                       'addons/gt_budget/report/resumen_gasto.mako',
                       parser=resumen_gasto,
                       header=True)

