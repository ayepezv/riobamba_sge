# -*- coding: utf-8 -*-
##############################################################################
#    
# Mario Chogllo
# mariofchogllo@gmail.com
#
##############################################################################


from report import report_sxw
from osv import osv
import operator
import time
import datetime
from datetime import date, timedelta
from tools import ustr
import operator

class cedulaCodificado(report_sxw.rml_parse):
    def __init__(self, cr, uid, name, context=None):
        super(cedulaCodificado, self).__init__(cr, uid, name, context=context)
        self.localcontext.update({
            'time': time,
            '_get_totales':self._get_totales,
            '_vars': self._vars,
        })

    def _vars(self,resumen):  
        res = { }          
        user=ustr(self.pool.get('res.users').browse(self.cr,self.uid,self.uid).name.upper())
        res['user']=user
        today=time.strftime('%Y-%m-%d %H:%M:%S')        
        res['date_from'] = resumen.date_from
        res['date_to'] = resumen.date_to
        return res 

    def crear_padre(self, data, data_suma, res):
        if data['post'].parent_id:
            data['padre'] = data['post'].parent_id
            if res.get(data['post'].parent_id.code,False):
                res[data['post'].parent_id.code]['planned_amount'] += data_suma['planned_amount']
                res[data['post'].parent_id.code]['codif_amount'] += data_suma['codif_amount']
            else:
                res[data['post'].parent_id.code] = {
                    'post': data['post'].parent_id,
                    'padre': False, 
                    'code':data['post'].parent_id.code,
                    'code_aux':data['post'].parent_id.code,
                    'general_budget_name':data['post'].parent_id.name,
                    'planned_amount':data['planned_amount'],
                    'codif_amount':data['codif_amount'],
                    'final': False,
                    'nivel': data['post'].parent_id.nivel-1,
                }
            self.crear_padre(res[data['post'].parent_id.code], data_suma,res)
            
    def _get_totales(self,resumen):
        res = { }
        res_line = { }
        context = { }
        result = []
        date_from = resumen.date_from
        date_to = resumen.date_to
        c_b_lines_obj = self.pool.get('budget.item')
        ids_lines=c_b_lines_obj.search(self.cr,self.uid,[('poa_id','=',resumen.poa_id.id),('type_budget','=','ingreso')])
        context = {'by_date':True,'date_start': date_from, 'date_end': date_to,'poa_id':resumen.poa_id.id}            
        planned_total=coded_total=reforma_total=balance_accured_total=practical_total=recaudado_total=0
        #        totales = c_b_lines_obj._compute_budget_all(self.cr, self.uid, ids_lines,[],[], context)
        for line in c_b_lines_obj.browse(self.cr,self.uid,ids_lines, context=context):
            if res_line.has_key(line.code)==False:
                code_aux = line.budget_post_id.code + '.' + line.program_id.sequence
                res_line[line.code]={
                    'post': line.budget_post_id,
                    'padre': False, 
                   # 'code':line.code,
                    'code':code_aux,#line.code_report,#line.code
                    'code_aux':code_aux,#line.code_report,
                    'general_budget_name':line.budget_post_id.name,
                    'planned_amount':line.planned_amount,
                    'codif_amount':line.codif_amount,
                    'nivel': line.budget_post_id.nivel-1,
                    'final': True,
                }
                if res_line.has_key(line.budget_post_id.code)==False:
                    code_aux = line.budget_post_id.code + '.' +line.program_id.sequence
                    res_line[line.budget_post_id.code]={
                        'post': line.budget_post_id,
                        'program': line.program_id.id,
                        'padre': False, 
                        'code': line.budget_post_id.code,
                        'code_aux':line.budget_post_id.code,
                        'general_budget_name':line.budget_post_id.name,
                        'planned_amount':line.planned_amount,
                        'codif_amount':line.codif_amount,
                        'final': True,
                        'nivel': line.budget_post_id.nivel-1,
                        'level': line.budget_post_id.nivel-1,
                    }
 #               else:
 #                   res_line[line.budget_post_id.code]['planned_amount']+=line.planned_amount
                self.crear_padre(res_line[line.code], res_line[line.code],res_line)
            else:                                
                res_line[line.budget_post_id.id+line.program_id.id]['planned_amount']+=line.planned_amount
        res_line['total']={'planned_amount': 0.00,
                           'codif_amount': 0.00,
                           'level':0,
                           'nivel':0,
                           'code':0,
                           'code_aux':0,
        }
        values=res_line.itervalues()
        for line_totales in values:
            if not 'level' in line_totales and line_totales['final']==True:
                res_line['total']['planned_amount']+=line_totales['planned_amount']
                res_line['total']['codif_amount']+=line_totales['codif_amount']        
        return res_line

    
report_sxw.report_sxw('report.cedula_codificado','cedulaCodificado',
                      'budget_report/report/cedula_codificado.mako',
                      parser=cedulaCodificado)


class cedulaCodificadoGasto(report_sxw.rml_parse):
    def __init__(self, cr, uid, name, context=None):
        super(cedulaCodificadoGasto, self).__init__(cr, uid, name, context=context)
        self.localcontext.update({
            'time': time,
            '_get_totales':self._get_totales,
            '_vars': self._vars,
            '_get_total_funcion':self._get_total_funcion,
            '_get_total_codif':self._get_total_codif,
        })

    def _get_total_presupuesto(self,poa,programa):
        aux = False
        if programa.sequence[0]=='1':
            aux = poa.total_presupuesto
        return aux

    def _get_total_codif(self,resumen):
        res = { }
        res_line = { }
        context = { }
        result = []
        date_from = resumen.date_from
        date_to = resumen.date_to
        c_b_lines_obj = self.pool.get('budget.item')
        ids_lines=c_b_lines_obj.search(self.cr,self.uid,[('poa_id','=',resumen.poa_id.id),('type_budget','=','gasto')])
        context = {'by_date':True,'date_start': date_from, 'date_end': date_to,'poa_id':resumen.poa_id.id}            
        planned_total=coded_total=reforma_total=balance_accured_total=practical_total=recaudado_total=0
        aux_total_presupuesto = 0
        for line in c_b_lines_obj.browse(self.cr,self.uid,ids_lines, context=context):
            aux_total_presupuesto += line.codif_amount
        return aux_total_presupuesto
        
    def _get_total_funcion(self,programa,poa):
        line_obj = self.pool.get('budget.poa.funcion')
        line_ids = line_obj.search(self.cr,self.uid,[('funcion','=',programa.sequence[0]),('p_id','=',poa.id)])
        aux = 0
        if line_ids:
            line = line_obj.browse(self.cr, self.uid, line_ids[0])
            aux = line.total
        return aux

    def _vars(self,resumen):  
        res = { }          
        user=ustr(self.pool.get('res.users').browse(self.cr,self.uid,self.uid).name.upper())
        res['user']=user
        today=time.strftime('%Y-%m-%d %H:%M:%S')        
        res['date_from'] = resumen.date_from
        res['date_to'] = resumen.date_to
        return res 

    def crear_padre(self, data, data_suma, res):
        if data['post'].parent_id:
            data['padre'] = data['post'].parent_id
            if res.get(data['post'].parent_id.code,False):
                res[data['post'].parent_id.code]['planned_amount'] += data_suma['planned_amount']
                res[data['post'].parent_id.code]['codif_amount'] += data_suma['codif_amount']
            else:
                res[data['post'].parent_id.code] = {
                    'post': data['post'].parent_id,
                    'padre': False, 
                    'code':data['post'].parent_id.code,
                    'code_aux':data['post'].parent_id.code,
                    'general_budget_name':data['post'].parent_id.name,
                    'planned_amount':data['planned_amount'],
                    'codif_amount':data['codif_amount'],
                    'final': False,
                    'nivel': data['post'].parent_id.nivel-1,
                }
            self.crear_padre(res[data['post'].parent_id.code], data_suma,res)
            
    def _get_totales(self,resumen):
        res = { }
        res_line = { }
        context = { }
        result = []
        date_from = resumen.date_from
        date_to = resumen.date_to
        c_b_lines_obj = self.pool.get('budget.item')
        ids_lines=c_b_lines_obj.search(self.cr,self.uid,[('program_id','=',resumen.program_id.id),('poa_id','=',resumen.poa_id.id),('type_budget','=','gasto')])
        context = {'by_date':True,'date_start': date_from, 'date_end': date_to,'poa_id':resumen.poa_id.id}            
        planned_total=coded_total=reforma_total=balance_accured_total=practical_total=recaudado_total=0
        #        totales = c_b_lines_obj._compute_budget_all(self.cr, self.uid, ids_lines,[],[], context)
        for line in c_b_lines_obj.browse(self.cr,self.uid,ids_lines, context=context):
            if res_line.has_key(line.code)==False:
                code_aux = line.budget_post_id.code + '.' + line.program_id.sequence
                res_line[line.code]={
                    'post': line.budget_post_id,
                    'padre': False, 
                   # 'code':line.code,
                    'code':code_aux,#line.code_report,#line.code
                    'code_aux':code_aux,#line.code_report,
                    'general_budget_name':line.budget_post_id.name,
                    'planned_amount':line.planned_amount,
                    'codif_amount':line.codif_amount,
                    'nivel': line.budget_post_id.nivel-1,
                    'final': True,
                }
                if res_line.has_key(line.budget_post_id.code)==False:
                    code_aux = line.budget_post_id.code + '.' +line.program_id.sequence
                    res_line[line.budget_post_id.code]={
                        'post': line.budget_post_id,
                        'program': line.program_id.id,
                        'padre': False, 
                        'code': line.budget_post_id.code,
                        'code_aux':line.budget_post_id.code,
                        'general_budget_name':line.budget_post_id.name,
                        'planned_amount':line.planned_amount,
                        'codif_amount':line.codif_amount,
                        'final': True,
                        'nivel': line.budget_post_id.nivel-1,
                        'level': line.budget_post_id.nivel-1,
                    }
 #               else:
 #                   res_line[line.budget_post_id.code]['planned_amount']+=line.planned_amount
                self.crear_padre(res_line[line.code], res_line[line.code],res_line)
            else:                                
                res_line[line.code]['planned_amount']+=line.planned_amount
                res_line[line.code]['codif_amount']+=line.codif_amount
#                res_line[line.budget_post_id.id+line.program_id.id]['planned_amount']+=line.planned_amount
        res_line['total']={'planned_amount': 0.00,
                           'codif_amount': 0.00,
                           'level':0,
                           'nivel':0,
                           'code':0,
                           'code_aux':0,
        }
        values=res_line.itervalues()
        for line_totales in values:
            if not 'level' in line_totales and line_totales['final']==True:
                res_line['total']['planned_amount']+=line_totales['planned_amount']
                res_line['total']['codif_amount']+=line_totales['codif_amount']        
        return res_line

    
report_sxw.report_sxw('report.cedula_codificado_gasto','cedulaCodificadoGasto',
                      'budget_report/report/cedula_codificado_gasto.mako',
                      parser=cedulaCodificadoGasto)

