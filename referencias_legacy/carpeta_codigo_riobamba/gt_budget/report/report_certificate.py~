# -*- coding: utf-8 -*-
##############################################################################
#    
#    OpenERP, Open Source Management Solution
#    Copyright (C) 2004-2010 Tiny SPRL (<http://tiny.be>).
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as
#    published by the Free Software Foundation, either version 3 of the
#    License, or (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.     
#
##############################################################################


from report import report_sxw
from osv import osv
#import calendar
import operator
import time
import datetime

class ReportCertificate(report_sxw.rml_parse):
    def __init__(self, cr, uid, name, context=None):
        super(ReportCertificate, self).__init__(cr, uid, name, context=context)
        self.localcontext.update({
            'time': time,
            'get_manager': self._get_manager
        })

    def _get_manager(self, manager_id):
        employee_name = self.pool.get('hr.employee').name_get(self.cr, self.uid, [manager_id])
        return employee_name[0][1]

report_sxw.report_sxw('report.crossovered.request','budget.certificate',
                      'addons/gt_budget/report/report_certificate.mako',
                      parser=ReportCertificate)


class ReportCompromise(report_sxw.rml_parse):
    def __init__(self, cr, uid, name, context):
        super(ReportCompromise, self).__init__(cr, uid, name, context=context)
        self.localcontext.update({
            'time': time,
        })

report_sxw.report_sxw('report.CompromisoPresupuestario.pdf','budget.certificate',
                      'addons/gt_budget/report/report_compromise.mako',
                      parser=ReportCompromise)


class BudgetCard(report_sxw.rml_parse):
    def __init__(self, cr, uid, name, context=None):
        super(BudgetCard, self).__init__(cr, uid, name, context=context)
        self.localcontext.update({
            'time': time,
            '_months':self._months,
            '_get_totales':self._get_totales,
           
        })
        
    ## def set_context(self, objects, data, ids, report_type=None):
    ##     c_b_lines_obj = self.pool.get('crossovered.budget.lines')
    ##     if data['type_report']
    ##     ids_lines=c_b_lines_obj.search(self.cr,self.uid,[('crossovered_budget_id.id','=',data['form']['budget_id']),('type_budget','=','ingreso')])
    ##     if ids_lines:
    ##         objects=self.pool.get('crossovered.budget').browse(self.cr,self.uid,data['form']['budget_id'])         
    ##         return super(BudgetCard, self).set_context(objects, data, ids, report_type=report_type)
    ##     else:
    ##        raise osv.except_osv('Error!!', 'No existen partidas tipo ingreso del presupuesto')
        
    def _months(self,resumen):  
        res = { }      
        user=str(self.pool.get('res.users').browse(self.cr,self.uid,self.uid).name.upper())
        res['user']=user                   
        today=time.strftime('%Y-%m-%d %H:%M:%S')        
        res['date']=today            
        begin = self.datas['form']['period_from'][1]
        if len(begin)>7:
            res['begin']=begin.upper()
        else:
            res['begin']=datetime.datetime.strptime(str(self.datas['form']['period_from'][1]), "%m/%Y").strftime("%B").upper()
        end = self.datas['form']['period_to'][1]
        if len(end)>7:
            res['end']=end.upper()
        else:
            res['end']=datetime.datetime.strptime(str(self.datas['form']['period_to'][1]), "%m/%Y").strftime("%B").upper()                
        return res 
    
    def _get_totales(self, budget_id, tipo='gasto', project_id=False):
        res = {}
        res_lines = {'lines': [],
                     'totales': {'planned_amount': 0,
                                 'reform_amount': 0,
                                 'codif_amount': 0,
                                 'commited_amount': 0,
                                 'devengado_amount': 0,
                                 'paid_amount': 0,
                                 'devengado_balance': 0,
                                 'commited_balance': 0,
                                 'avai_amount': 0,
                                 }}
        context = {}
        result = []
        period_from = int(self.datas['form']['period_from'][0])
        period_to = int(self.datas['form']['period_to'][0])
        cb_obj = self.pool.get('budget.item')
        domain = [('poa_id','=',budget_id),('type_budget','=',tipo)]
        if project_id:
            domain.append(('project_id','=',project_id))
        cb_ids = cb_obj.search(self.cr, self.uid, domain)
        context = {'period_from': period_from, 'period_to': period_to}            
        planned_total = 0
        coded_total = 0
        reforma_total = 0
        balance_accured_total = 0
        practical_total = 0
        recaudado_total = 0
        for line in cb_obj.browse(self.cr, self.uid, cb_ids):    
            res_lines['lines'].append({'general_budget_name': line.budget_post_id.name,
                                       'planned_amount': line.planned_amount,
                                       'reform_amount': line.reform_amount,
                                       'codif_amount': line.codif_amount,
                                       'commited_amount': line.commited_amount,
                                       'devengado_amount': line.devengado_amount,
                                       'paid_amount': line.paid_amount,
                                       'devengado_balance': line.devengado_balance,
                                       'commited_balance': line.commited_balance,
                                       'avai_amount': line.avai_amount,
                                       'code': line.code})
            res_lines['totales']['planned_amount'] += line.planned_amount
            res_lines['totales']['reform_amount'] += line.reform_amount
            res_lines['totales']['codif_amount'] += line.codif_amount
            res_lines['totales']['commited_amount'] += line.commited_amount
            res_lines['totales']['devengado_amount'] += line.devengado_amount
            res_lines['totales']['paid_amount'] += line.paid_amount
            res_lines['totales']['devengado_balance'] += line.devengado_balance
            res_lines['totales']['commited_balance'] += line.commited_balance
            res_lines['totales']['avai_amount'] += line.avai_amount
        return res_lines


report_sxw.report_sxw('report.BudgetCard','budget.poa',
                      'gt_budget/report/report_budget_card.mako',
                      parser=BudgetCard)

class BudgetCardIncome(report_sxw.rml_parse):
    def __init__(self, cr, uid, name, context=None):
        super(BudgetCardIncome, self).__init__(cr, uid, name, context=context)
        self.localcontext.update({
            'time': time,
            '_months':self._months,
            '_get_totales':self._get_totales,
           
        })
        
    def set_context(self, objects, data, ids, report_type=None):
        c_b_lines_obj = self.pool.get('crossovered.budget.lines')
        ids_lines=c_b_lines_obj.search(self.cr,self.uid,[('crossovered_budget_id.id','=',data['form']['budget_id']),('type_budget','=','ingreso')])
        if ids_lines:
            objects=self.pool.get('crossovered.budget').browse(self.cr,self.uid,data['form']['budget_id'])         
            return super(BudgetCardIncome, self).set_context(objects, data, ids, report_type=report_type)
        else:
           raise osv.except_osv('Error!!', 'No existen partidas tipo ingreso del presupuesto')
        
    def _months(self,resumen):  
        res = { }                       
        begin = self.datas['form']['period_from'][1]
        user=str(self.pool.get('res.users').browse(self.cr,self.uid,self.uid).name.upper())
        res['user']=user
        today=time.strftime('%Y-%m-%d %H:%M:%S')        
        res['date']=today
        today=time.strftime('%Y-%m-%d %H:%M:%S')        
        res['date']=today                                            
        if len(begin)>7:
            res['begin']=begin.upper()
        else:
            res['begin']=datetime.datetime.strptime(str(self.datas['form']['period_from'][1]), "%m/%Y").strftime("%B").upper()
        end = self.datas['form']['period_to'][1]
        if len(end)>7:
            res['end']=end.upper()
        else:
            res['end']=datetime.datetime.strptime(str(self.datas['form']['period_to'][1]), "%m/%Y").strftime("%B").upper()   
        return res 

    def _get_totales(self,resumen):
        print "====44444444444444"
        res = { }
        res_line = { }
        context = { }
        result = []
        period_from = int(self.datas['form']['period_from'][0])
        period_to = int(self.datas['form']['period_to'][0])
        c_b_lines_obj = self.pool.get('crossovered.budget.lines')
        ids_lines=c_b_lines_obj.search(self.cr,self.uid,[('crossovered_budget_id.id','=',resumen.id),('type_budget','=','ingreso')])
        context = {'period_from': period_from, 'period_to': period_to}            
        planned_total=coded_total=reforma_total=balance_accured_total=practical_total=recaudado_total=0
        totales = c_b_lines_obj._compute_budget_all(self.cr, self.uid, ids_lines,[],[], context)                                                
        for line in c_b_lines_obj.browse(self.cr,self.uid,ids_lines):    
            if res_line.has_key(line.general_budget_id.id)==False:
                res_line[line.general_budget_id.id]={'code':line.general_budget_id.code,
                                                     'general_budget_name':line.general_budget_id.name,
                                                     'planned_amount':line.planned_amount,
                                                     'practical_amount':line.practical_amount,
                                                     'balance_acurred_amount':line.balance_accured,
                                                     'recaudado_amount':recaudado_total,     
                                                     'coded_amount':totales[line.id]['coded_amount'],
                                                     'reform_amount':totales[line.id]['reforma_amount'],                                                
                                                     }                    
            else:                                
                res_line[line.general_budget_id.id]['planned_amount']+=line.planned_amount
                res_line[line.general_budget_id.id]['practical_amount']+=line.practical_amount
                res_line[line.general_budget_id.id]['balance_acurred_amount']+=line.balance_accured
                res_line[line.general_budget_id.id]['recaudado_amount']+=recaudado_total
                res_line[line.general_budget_id.id]['coded_amount']+=totales[line.id]['coded_amount']
                res_line[line.general_budget_id.id]['reform_amount']+=totales[line.id]['reforma_amount']
        res_line['total']={'reforma_amount': 0.00,
                          'practical_amount': 0.00,
                          'recaudado_amount': 0.00,
                          'planned_amount': 0.00,
                          'balance_acurred_amount': 0.00,
                          'coded_amount': 0.00,
                          'nivel':0,
                          'code':0
                          }
        values=res_line.itervalues()
        for line_totales in values:
            if not 'nivel' in line_totales:
                res_line['total']['planned_amount']+=line_totales['planned_amount']            
                res_line['total']['reforma_amount']+=line_totales['reforma_amount']
                res_line['total']['coded_amount']+=line_totales['coded_amount']
                res_line['total']['practical_amount']+=line_totales['practical_amount']
                res_line['total']['recaudado_amount']+=line_totales['recaudado_amount']            
                res_line['total']['balance_acurred_amount']+=line_totales['balance_acurred_amount']
        return res_line

report_sxw.report_sxw('report.BudgetCardIncome','crossovered.budget',
                      'gt_account_budget/report/report_budget_card_income.mako',
                      parser=BudgetCardIncome)

class BudgetCardExpense(report_sxw.rml_parse):
    def __init__(self, cr, uid, name, context=None):
        super(BudgetCardExpense, self).__init__(cr, uid, name, context=context)
        self.localcontext.update({
            'time': time,
            '_months':self._months,
            '_get_totales':self._get_totales,
           
        })
        
    def set_context(self, objects, data, ids, report_type=None):
        if data['form']['project']==True and data['form']['project_id']:
            objects=self.pool.get('crossovered.budget').browse(self.cr,self.uid,data['form']['budget_id'])         
            return super(BudgetCardExpense, self).set_context(objects, data, ids, report_type=report_type)
        else:
            raise osv.except_osv('Error!!', 'Debe seleccionar un Proyecto')
        
    def _months(self,resumen):  
        res = { }                       
        user=str(self.pool.get('res.users').browse(self.cr,self.uid,self.uid).name.upper())
        res['user']=user
        today=time.strftime('%Y-%m-%d %H:%M:%S')        
        res['date']=today                                        
        begin = self.datas['form']['period_from'][1]
        today=time.strftime('%Y-%m-%d %H:%M:%S')        
        res['date']=today
        if len(begin)>7:
            res['begin']=begin.upper()
        else:
            res['begin']=datetime.datetime.strptime(str(self.datas['form']['period_from'][1]), "%m/%Y").strftime("%B").upper()
        end = self.datas['form']['period_to'][1]
        if len(end)>7:
            res['end']=end.upper()
        else:
            res['end']=datetime.datetime.strptime(str(self.datas['form']['period_to'][1]), "%m/%Y").strftime("%B").upper()   
        project=self.datas['form']['project_id'][1]
        proyecto=self.pool.get('project.project').browse(self.cr,self.uid,[self.datas['form']['project_id'][0]])[0]              
        res['project']=project.upper()
        res['program']=proyecto.program_id.name
        return res 
    
    def _get_totales(self,resumen):  
        res = { }
        res_line = {}
        context = { }
        result_dic = {}
        pos =0
        print "LLLLLLLLLLL"
        if self.datas['form']['project']==True and self.datas['form']['project_id']:
            project_id=self.datas['form']['project_id']
            period_from = int(self.datas['form']['period_from'][0])
            period_to = int(self.datas['form']['period_to'][0])
            c_b_lines_obj = self.pool.get('crossovered.budget.lines')
            ids_lines=c_b_lines_obj.search(self.cr,self.uid,[('crossovered_budget_id.id','=',resumen.id),('type_budget','=','gasto'),('task_id.project_id.id','=',project_id[0])])
            context = {'period_from': period_from, 'period_to': period_to}            
            planned_total=coded_total=reforma_total=balance_accured_total=practical_total=recaudado_total=0
            totales = c_b_lines_obj._compute_budget_all(self.cr, self.uid, ids_lines,[],[], context)                                                     
            for line in c_b_lines_obj.browse(self.cr,self.uid,ids_lines):                    
                if res_line.has_key(line.general_budget_id.id)==False:
                    res_line[line.general_budget_id.id]={'code':str(project_id[0])+"."+line.general_budget_id.code,
                                                         'general_budget_name':line.general_budget_id.name,
                                                         'planned_amount':line.planned_amount,
                                                         'practical_amount':line.practical_amount,
                                                         'balance_acurred_amount':line.balance_accured,
                                                         'recaudado_amount':recaudado_total,     
                                                         'coded_amount':totales[line.id]['coded_amount'],
                                                         'reforma_amount':totales[line.id]['reforma_amount'],
                                                         'paid_amount':totales[line.id]['paid_amount'],
                                                         'commited_amount':totales[line.id]['commited_amount'],
                                                         'nivel':1                                                
                                                         }
                    
                    if res_line.has_key(line.general_budget_id.id*(line.id+1))==False:
                        res_line[line.general_budget_id.id*(line.id+1)]={'code':str(project_id[0])+"."+line.general_budget_id.code+".1",
                                                         'general_budget_name':line.full_name,
                                                         'planned_amount':line.planned_amount,
                                                         'practical_amount':line.practical_amount,
                                                         'balance_acurred_amount':line.balance_accured,
                                                         'recaudado_amount':recaudado_total,     
                                                         'coded_amount':totales[line.id]['coded_amount'],
                                                         'reforma_amount':totales[line.id]['reforma_amount'],
                                                         'paid_amount':totales[line.id]['paid_amount'],
                                                         'commited_amount':totales[line.id]['commited_amount'],
                                                         'nivel':2}
                        
                else:
                    if res_line.has_key(line.general_budget_id.id*(line.id+1))==False:
                        res_line[line.general_budget_id.id*(line.id+1)]={'code':str(project_id[0])+"."+line.general_budget_id.code+".1",
                                                         'general_budget_name':line.full_name,
                                                         'planned_amount':line.planned_amount,
                                                         'practical_amount':line.practical_amount,
                                                         'balance_acurred_amount':line.balance_accured,
                                                         'recaudado_amount':recaudado_total,     
                                                         'coded_amount':totales[line.id]['coded_amount'],
                                                         'reforma_amount':totales[line.id]['reforma_amount'],
                                                         'paid_amount':totales[line.id]['paid_amount'],
                                                         'commited_amount':totales[line.id]['commited_amount'],
                                                         'nivel':2}
                        
                    res_line[line.general_budget_id.id]['planned_amount']+=line.planned_amount
                    res_line[line.general_budget_id.id]['practical_amount']+=line.practical_amount
                    res_line[line.general_budget_id.id]['balance_acurred_amount']+=line.balance_accured
                    res_line[line.general_budget_id.id]['recaudado_amount']+=recaudado_total
                    res_line[line.general_budget_id.id]['coded_amount']+=totales[line.id]['coded_amount']
                    res_line[line.general_budget_id.id]['reforma_amount']+=totales[line.id]['reforma_amount']
                    res_line[line.general_budget_id.id]['paid_amount']+=totales[line.id]['paid_amount']
                    res_line[line.general_budget_id.id]['commited_amount']+=totales[line.id]['commited_amount']
            res_line['total']={'reforma_amount': 0.00,
                              'practical_amount': 0.00,
                              'recaudado_amount': 0.00,
                              'planned_amount': 0.00,
                              'paid_amount': 0.00,
                              'commited_amount': 0.00,
                              'balance_acurred_amount': 0.00,
                              'coded_amount': 0.00,
                              'general_budget_name': "TOTAL",
                              'code': 0,
                              'nivel': 0,                                                                                    
                              }
            values=res_line.itervalues()
            for line_totales in values:
                if 'nivel' in line_totales:
                    if line_totales['nivel']==1:
                        res_line['total']['planned_amount']+=line_totales['planned_amount']            
                        res_line['total']['reforma_amount']+=line_totales['reforma_amount']
                        res_line['total']['coded_amount']+=line_totales['coded_amount']
                        res_line['total']['practical_amount']+=line_totales['practical_amount']
                        res_line['total']['recaudado_amount']+=line_totales['recaudado_amount']            
                        res_line['total']['balance_acurred_amount']+=line_totales['balance_acurred_amount']
                        res_line['total']['paid_amount']+=line_totales['paid_amount']
                        res_line['total']['commited_amount']+=line_totales['commited_amount']
            res_dic=res_line.values()             
            result_dic=sorted(res_dic, key=operator.itemgetter('code'))                      
            return result_dic 
        else:
            return False

report_sxw.report_sxw('report.BudgetCardExpense','crossovered.budget',
                      'gt_account_budget/report/report_budget_card_expense.mako',
                      parser=BudgetCardExpense)

class BudgetCardExpenseGroup(report_sxw.rml_parse):
    def __init__(self, cr, uid, name, context=None):
        super(BudgetCardExpenseGroup, self).__init__(cr, uid, name, context=context)
        self.localcontext.update({
            'time': time,
            '_months':self._months,
            '_get_totales':self._get_totales,
           
        })
        
    def set_context(self, objects, data, ids, report_type=None):
        if data['form']['project']==True: #and data['form']['project_id']:
            if data['form']['project_id']:
                objects=self.pool.get('crossovered.budget').browse(self.cr,self.uid,data['form']['budget_id'])         
                return super(BudgetCardExpenseGroup, self).set_context(objects, data, ids, report_type=report_type)
            else:
                raise osv.except_osv('Error!!', 'Debe seleccionar un Proyecto')
        objects=self.pool.get('crossovered.budget').browse(self.cr,self.uid,data['form']['budget_id'])         
        return super(BudgetCardExpenseGroup, self).set_context(objects, data, ids, report_type=report_type)
        
    def _months(self,resumen):  
        res = { }                       
        user=str(self.pool.get('res.users').browse(self.cr,self.uid,self.uid).name.upper())
        res['user']=user
        today=time.strftime('%Y-%m-%d %H:%M:%S')        
        res['date']=today                                        
        begin = self.datas['form']['period_from'][1]
        today=time.strftime('%Y-%m-%d %H:%M:%S')        
        res['date']=today
        if len(begin)>7:
            res['begin']=begin.upper()
        else:
            res['begin']=datetime.datetime.strptime(str(self.datas['form']['period_from'][1]), "%m/%Y").strftime("%B").upper()
        end = self.datas['form']['period_to'][1]
        if len(end)>7:
            res['end']=end.upper()
        else:
            res['end']=datetime.datetime.strptime(str(self.datas['form']['period_to'][1]), "%m/%Y").strftime("%B").upper()
        if self.datas['form']['project_id']:
            project=self.datas['form']['project_id'][1]
            proyecto=self.pool.get('project.project').browse(self.cr,self.uid,[self.datas['form']['project_id'][0]])[0]              
            res['project']=project.upper()
            res['program']=proyecto.program_id.name
        else:
            res['project']=''
            res['program']=''
        return res 
    
    def _get_totales(self,resumen):  
        print "333333333333333333333333333332"
        res = { }
        res_line = {}
        context = { }
        result_dic = {}
        pos =0
        if self.datas['form']['project']==True and self.datas['form']['project_id']:
            project_id=self.datas['form']['project_id']
            period_from = int(self.datas['form']['period_from'][0])
            period_to = int(self.datas['form']['period_to'][0])
            c_b_lines_obj = self.pool.get('crossovered.budget.lines')
            ids_lines=c_b_lines_obj.search(self.cr,self.uid,[('crossovered_budget_id.id','=',resumen.id),('type_budget','=','gasto'),('task_id.project_id.id','=',project_id[0])])
            context = {'period_from': period_from, 'period_to': period_to}            
            planned_total=coded_total=reforma_total=balance_accured_total=practical_total=recaudado_total=0
            totales = c_b_lines_obj._compute_budget_all(self.cr, self.uid, ids_lines,[],[], context)                                                    
            for line in c_b_lines_obj.browse(self.cr,self.uid,ids_lines):                    
                if res_line.has_key(line.general_budget_id.id)==False:
                    res_line[line.general_budget_id.id]={'code':str(project_id[0])+"."+line.general_budget_id.code,
                                                         'general_budget_name':line.general_budget_id.name,
                                                         'planned_amount':line.planned_amount,                                                         
                                                         'balance_acurred_amount':line.balance_accured,
                                                         'paid_amount':totales[line.id]['paid_amount'],
                                                         'commited_amount':totales[line.id]['commited_amount'],
                                                         'nivel':1                                                
                                                         }
                    
                    if res_line.has_key(line.general_budget_id.id*(line.id+1))==False:
                        res_line[line.general_budget_id.id*(line.id+1)]={'code':str(project_id[0])+"."+line.general_budget_id.code+".1",
                                                         'general_budget_name':line.full_name,
                                                         'planned_amount':line.planned_amount,                                                         
                                                         'balance_acurred_amount':line.balance_accured,
                                                         'paid_amount':totales[line.id]['paid_amount'],
                                                         'commited_amount':totales[line.id]['commited_amount'],
                                                         'nivel':2}
                        
                else:
                    if res_line.has_key(line.general_budget_id.id*(line.id+1))==False:
                        res_line[line.general_budget_id.id*(line.id+1)]={'code':str(project_id[0])+"."+line.general_budget_id.code+".1",
                                                         'general_budget_name':line.full_name,
                                                         'planned_amount':line.planned_amount,
                                                         'balance_acurred_amount':line.balance_accured,
                                                         'paid_amount':totales[line.id]['paid_amount'],
                                                         'commited_amount':totales[line.id]['commited_amount'],
                                                         'nivel':2}
                        
                    res_line[line.general_budget_id.id]['planned_amount']+=line.planned_amount         
                    res_line[line.general_budget_id.id]['balance_acurred_amount']+=line.balance_accured                               
                    res_line[line.general_budget_id.id]['paid_amount']+=totales[line.id]['paid_amount']
                    res_line[line.general_budget_id.id]['commited_amount']+=totales[line.id]['commited_amount']
            res_line['total']={                                                           
                              'planned_amount': 0.00,
                              'balance_acurred_amount': 0.00,
                              'commited_amount': 0.00,
                              'paid_amount': 0.00,
                              'general_budget_name': "TOTAL",
                              'code': 0,
                              'nivel': 0,                                                                                    
                              }
            values=res_line.itervalues()
            for line_totales in values:
                if 'nivel' in line_totales:
                    if line_totales['nivel']==1:
                        res_line['total']['planned_amount']+=line_totales['planned_amount']            
                        res_line['total']['commited_amount']+=line_totales['commited_amount']
                        res_line['total']['paid_amount']+=line_totales['paid_amount']                        
                        res_line['total']['balance_acurred_amount']+=line_totales['balance_acurred_amount']
            res_dic=res_line.values()             
            result_dic=sorted(res_dic, key=operator.itemgetter('code'))            
            return result_dic 
        else:
            return False

report_sxw.report_sxw('report.BudgetCardExpenseGroup','crossovered.budget',
                      'gt_account_budget/report/report_budget_card_expense_group.mako',
                      parser=BudgetCardExpenseGroup)
