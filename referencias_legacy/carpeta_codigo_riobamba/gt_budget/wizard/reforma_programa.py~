# -*- coding: utf-8 -*-
##############################################################################
#
# Mario Chogllo
# mariofchogllo@gmail.com
#
##############################################################################

import time
from osv import fields, osv
from time import strftime
import netsvc

class projectEjectNew(osv.TransientModel):
   _name = 'project.eject.new'

   def project_eject_new(self, cr, uid, ids, context):
      project_obj = self.pool.get('project.project')
      wf_service = netsvc.LocalService("workflow")
      data = self.read(cr, uid, ids[0])
      project_ids = project_obj.search(cr, uid, [('fy_id','=',data['year_id'][0])])
      if project_ids:
         for project_id in project_ids:
            wf_service.trg_validate(uid, 'project.project', project_id, 'signal_planning', cr)
            wf_service.trg_validate(uid, 'project.project', project_id, 'signal_planning', cr)
            wf_service.trg_validate(uid, 'project.project', project_id, 'signal_execution', cr)
      return True

   _columns = dict(
      year_id = fields.many2one('account.fiscalyear','Anio Fiscal'),
   )
projectEjectNew()

class budgetCierre(osv.TransientModel):
   _description = 'Cierre Presupuestario'
   _name ='budget.cierre'

   def budget_cerrar(self, cr, uid, ids, context):
      # solo crea proyecto tarea los items con otro wizard el mismo que importa de excel
      wf_service = netsvc.LocalService("workflow")
      project_obj = self.pool.get('project.project')
      project_task = self.pool.get('project.task')
      item_obj = self.pool.get('budget.item')
      budget_obj = self.pool.get('budget.budget')
      this = self.browse(cr, uid, ids[0])
      project_ids = project_obj.search(cr, uid, [('poa_id','=',this.poa_ant_id.id)])
      if project_ids:
         for project_id in project_ids:
            project_ant = project_obj.browse(cr, uid, project_id)
            id_new = project_obj.create(cr, uid, {
               'fy_id':this.year_id.id,
               'code':project_ant.code,
               'name':project_ant.name,
               'poa_id':this.poa_id.id,
               'date_start':this.poa_id.date_start,
               'date':this.poa_id.date_end,
               'department_id':project_ant.department_id.id,
               'user_id':project_ant.user_id.id,
               'axis_id':project_ant.axis_id.id,
               'estrategy_id':project_ant.estrategy_id.id,
               'program_id':project_ant.program_id.id,
               'type_id':project_ant.type_id.id,
               'type_budget':project_ant.type_budget,
               'canton_id':project_ant.canton_id.id,
               'parish_id':project_ant.parish_id.id,
               'background':project_ant.background,
               'justification':project_ant.justification,
               'general_objective':project_ant.general_objective,
               'specific_objectives':project_ant.specific_objectives,
            })
            for activity in project_ant.tasks:
               activity_id = project_task.create(cr, uid, {
                  'name':activity.name,
                  'weight':activity.weight,
                  'date_start':this.poa_id.date_start,
                  'date_end':this.poa_id.date_end,
                  'project_id':id_new,
                  'task_ant':activity.id,
               })
               #crea budget items
               for item_line in activity.budget_planned_ids:
                  planificado = 0 
                  if this.valor=='valor':
                     planificado = item_line.planned_amount
                  item_id = item_obj.create(cr, uid, {
                     'budget_post_id':item_line.budget_post_id.id,
                     'planned_amount':planificado,
                     'task_id':activity_id,
                     'suplemento':0,
                     'reduccion':0,
                     'traspaso_aumento':0,
                     'traspaso_disminucion':0,
                     'reform_amount':0,
                     'request_amount':0,
                     'codif_amount':0,
                     'commited_amount':0,
                     'reserved_amount':0,
                     'devengado_amount':0,
                     'paid_amount':0,
                     'commited_balance':0,
                     'commited_sobregiro':0,
                     'devengado_sobregiro':0,
                     'devengado_balance':0,
                     'avai_amount':0,
                  })
#            project_obj.write(cr, uid, project_id,{
#               'state':'done',
#            })
      return True

   _columns = dict(
      valor = fields.selection([('valor','Con Valores Anteriores'),('cero','En cero')],'Pasar valores'),
      year_ant_id = fields.many2one('account.fiscalyear','Periodo Cerrar'),
      year_id = fields.many2one('account.fiscalyear','Periodo Planificacion'),
      poa_ant_id = fields.many2one('budget.poa','Presupuesto Cerrar'),
      poa_id = fields.many2one('budget.poa','Presupuesto'),
   )
budgetCierre()


